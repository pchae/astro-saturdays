---
import DashboardLayout from "../layouts/Dashboard.astro";
import DashboardHeader from "../components/dashboard/DashboardHeader.astro";
import DashboardNav from "../components/dashboard/DashboardNav.astro";
import { StatCard } from "../components/ui/stat-card";
import { FighterSection } from "../components/dashboard/fighter-section";
import { checkAuth } from "../lib/auth";
import { AuthCookieManager } from "../lib/auth/CookieManager";

// Use the auth middleware
export const prerender = false;

console.log("[Dashboard] Page load started");

// Log all request headers for debugging
const headers = Object.fromEntries(
  Array.from(Astro.request.headers.entries())
);
console.log("[Dashboard] All request headers:", headers);

// Log cookie details
const cookieHeader = Astro.request.headers.get('cookie');
console.log("[Dashboard] Raw cookie header:", cookieHeader);

const cookieManager = new AuthCookieManager(Astro);
const { data: tokens } = cookieManager.getAuthTokens();
const { data: sessionData } = cookieManager.getSessionData();

console.log("[Dashboard] Auth cookie state:", {
  hasTokens: !!tokens,
  hasSession: !!sessionData,
  tokenDetails: tokens ? {
    hasAccessToken: !!tokens.accessToken,
    accessTokenLength: tokens.accessToken?.length,
    hasRefreshToken: !!tokens.refreshToken,
    refreshTokenLength: tokens.refreshToken?.length,
  } : null,
  sessionDetails: sessionData ? {
    hasUser: !!sessionData.user,
    userEmail: sessionData.user?.email,
    expiresAt: sessionData.expiresAt
  } : null
});

// Initialize variables
let user;
let email;

// Dashboard data
const stats = [
  { name: 'Number of deploys', value: '9999' },
  { name: 'Average deploy time', value: '32', unit: 'seconds' },
  { name: 'Instances', value: '1' },
  { name: 'Status', value: 'ONLINE' },
];

// Mock fighter data - in a real app, this would come from an API or database
const ufcFighters = [
  { id: '1', name: 'Jon Jones', organization: 'UFC', image: '/pfp/2335639.png' },
  { id: '2', name: 'Alex Pereira', organization: 'UFC', image: '/pfp/4705658.png' },
  { id: '3', name: 'Alexander Volkanovski', organization: 'UFC', image: '/pfp/3949584.png' },
];

console.log("[Dashboard] Starting auth check");
try {
  const authResult = await checkAuth(Astro);
  console.log("[Dashboard] Auth check completed:", {
    hasSession: !!authResult.session,
    hasRedirect: !!authResult.redirect,
    sessionData: authResult.session ? {
      hasUser: !!authResult.session.user,
      userEmail: authResult.session.user?.email,
      expiresAt: authResult.session.expires_at
    } : null
  });

  if (authResult.redirect) {
    console.log("[Dashboard] Auth check failed, redirecting to signin");
    return authResult.redirect;
  }

  // Get user data from session
  user = authResult.session?.data?.user;
  email = user?.email;

  console.log("[Dashboard] Auth successful, rendering page");
} catch (error) {
  console.error("[Dashboard] Error during auth check:", {
    message: error.message,
    stack: error.stack?.split('\n')[0]
  });
  return Astro.redirect("/signin");
}
---

<DashboardLayout title="Dashboard - Saturdays.io" email={email} user={user}>
  <DashboardNav />

  <section class="p-4 bg-black">
    <DashboardHeader />

    <!-- Stats -->
    <dl class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 mt-8 gap-4">
      {stats.map(stat => (
        <StatCard
          client:load
          name={stat.name}
          value={stat.value}
          unit={stat.unit}
        />
      ))}
    </dl>

    <!-- Fighter sections -->
    <div class="pt-8">
      <FighterSection client:load title="UFC Fighters" fighters={ufcFighters} />
    </div>
  </section>
</DashboardLayout>
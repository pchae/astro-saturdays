---
import Layout from "../layouts/Layout.astro";
import { supabase } from "../lib/supabase";
import DashboardNav from "../components/DashboardNav.astro";
import DashboardHeader from "../components/DashboardHeader.astro";
import StatCard from "../components/StatCard.astro";
import AdminToolCard from "../components/AdminToolCard.astro";
import FighterSection from "../components/FighterSection.astro";

// Auth logic
export const prerender = false;
const accessToken = Astro.cookies.get("sb-access-token");
const refreshToken = Astro.cookies.get("sb-refresh-token");

if (!accessToken || !refreshToken) {
  return Astro.redirect("/signin");
}

let session;
try {
  session = await supabase.auth.setSession({
    refresh_token: refreshToken.value,
    access_token: accessToken.value,
  });
  if (session.error) {
    Astro.cookies.delete("sb-access-token", {
      path: "/",
    });
    Astro.cookies.delete("sb-refresh-token", {
      path: "/",
    });
    return Astro.redirect("/signin");
  }
} catch (error) {
  Astro.cookies.delete("sb-access-token", {
    path: "/",
  });
  Astro.cookies.delete("sb-refresh-token", {
    path: "/",
  });
  return Astro.redirect("/signin");
}

const email = session.data.user?.email;

// Dashboard data
const stats = [
  { name: 'Number of deploys', value: '9999' },
  { name: 'Average deploy time', value: '32', unit: 'seconds' },
  { name: 'Instances', value: '1' },
  { name: 'Status', value: 'ONLINE' },
];

const adminTools = [
  {
    name: 'Algolia Sync',
    description: 'Synchronize MMA database with Algolia search indices',
    to: '/admin/algolia-sync',
    icon: 'i-heroicons-arrow-path',
  },
];

// Mock fighter data - in a real app, this would come from an API or database
const ufcFighters = [
  { id: '1', name: 'Jon Jones', organization: 'UFC', image: '/pfp/2335639.png' },
  { id: '2', name: 'Alex Pereira', organization: 'UFC', image: '/pfp/4705658.png' },
  { id: '3', name: 'Alexander Volkanovski', organization: 'UFC', image: '/pfp/3949584.png' },
];
---

<Layout title="Dashboard - Saturdays.io">
  <div class="min-h-full bg-black">
    <DashboardNav email={email} />
    
    <main class="py-24">
      <div class="mx-auto max-w-full px-4">
        <section>
          <DashboardHeader />

          <!-- Stats -->
          <dl class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 mt-8 gap-0">
            {stats.map(stat => (
              <StatCard stat={stat} />
            ))}
          </dl>

          <!-- Fighter sections -->
          <div class="pt-8">
            <FighterSection title="UFC Fighters" fighters={ufcFighters} />
          </div>
        </section>
      </div>
    </main>
  </div>
</Layout>
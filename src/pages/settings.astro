---
import DashboardLayout from "../layouts/Dashboard.astro";
import { SettingsTabs } from "../components/settings/SettingsTabs";
import DashboardNav from "../components/dashboard/DashboardNav.astro";
// import { isPublicRoute } from "../middleware/auth";
import { createServerClient, type CookieOptions } from '@supabase/ssr';

// Check authentication
export const prerender = false;

// Supabase client setup - from dashboard.astro
const supabase = createServerClient(
  import.meta.env.PUBLIC_SUPABASE_URL,
  import.meta.env.PUBLIC_SUPABASE_ANON_KEY,
  {
    cookies: {
      get: (key: string) => Astro.cookies.get(key)?.value,
      set: (key: string, value: string, options: CookieOptions) => {
        Astro.cookies.set(key, value, {
          ...options,
          path: '/',
        });
      },
      remove: (key: string, options: CookieOptions) => {
        Astro.cookies.delete(key, {
          ...options,
          path: '/',
        });
      },
    },
  }
)

// Get session from cookies
const { data: { session } } = await supabase.auth.getSession();

if (!session) {
  return Astro.redirect('/signin');
}

// Get user data for layout - from session
const user = session.user;


// Get auth state from middleware
//const authResult = await checkAuth(Astro);
// if (authResult.redirect) return authResult.redirect;

// Get user data for layout
//const user = authResult.session?.data?.user;
//if (!user) {
//  return Astro.redirect('/signin');
//}

// Get the active tab from URL hash or default to 'profile'
const hash = Astro.url.hash.slice(1) || 'profile';
---

<DashboardLayout title="Settings - Saturdays.io" email={user.email} user={user}>
  <DashboardNav />
  <div class="container p-4">
    <h1 class="text-3xl font-bold mb-8">Account Settings</h1>
    <SettingsTabs client:load defaultTab={hash} />
  </div>
</DashboardLayout>
